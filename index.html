<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ูุณุชูุจู ุงูุดุฑููุฉ</title>

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="manifest.json">
   <link rel="assetlinks" href="https://shehabt1000-boop.github.io/.well-known/assetlinks.json" type="application/json">

    <meta name="theme-color" content="#1e40af">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>


        /* ุงุณุชุฎุฏุงู ุฎุท Cairo ูุฎุท ุฃุณุงุณู ูููุญุชูู ุงูุนุฑุจู */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            direction: rtl; /* ุถูุงู ุงูุงุชุฌุงู ูู ุงููููู ูููุณุงุฑ */
        }
        /* ุชุนุฏููุงุช ุจุณูุทุฉ ูู Tailwind ูุฏุนู RTL ุจุดูู ุฃูุถู */
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
        /* ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฑูุฑ ูุน ุงูุญูุงุธ ุนูู ูุธููุชู */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* ุฃููููุงุช SVG ูููุฌูู (ููุชูููู) */
        .star-icon {
            width: 1.5rem;
            height: 1.5rem;
            fill: currentColor;
            display: inline-block;
        }




        /* === ุชุนุฏูู ููุงุนุงุช ุงูุดุงุช === */
        .chat-bubble-sent {
            background-color: #1e40af; /* bg-blue-800 */
            color: white; 
            padding: 0.6rem 0.75rem; 
            border-radius: 1.25rem 1.25rem 0 1.25rem; 
            word-wrap: break-word; 
        }
        .chat-bubble-received {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #1f2937; 
            padding: 0.6rem 0.75rem; 
            border-radius: 1.25rem 1.25rem 1.25rem 0; 
            word-wrap: break-word; 
        }




        /* truncate */
        .truncate-1-line {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }




        /* ุชูููู ุงูุชุจุงุนุฏุงุช ุงูุงูุชุฑุงุถูุฉ */
        .main-padding {
            padding: 0.75rem; /* p-3 */
        }
        @media (min-width: 768px) {
            .main-padding {
                padding: 2rem; 
            }
        }




        /* === ุฅุตูุงุญ 1: ุชุตุบูุฑ ุงุฑุชูุงุน ุงูุจุงุฑ ุงูุนููู === */
        .app-header {
            padding: 0.5rem 0.75rem; 
        }
        /* === ุฅุตูุงุญ 1: ุชุตุบูุฑ ุงุฑุชูุงุน ุจุงุฑ ุงูุชุฑุญูุจ === */
        .welcome-header {
            padding: 0.6rem 1rem; 
        }
    </style>
</head>
<body class="bg-gray-50">




    <!-- ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ ููุชุทุจูู -->
    <div id="app" class="max-w-lg mx-auto min-h-screen bg-white shadow-lg md:max-w-2xl lg:max-w-4xl">
        <!-- ุณูุชู ุญูู ุงููุญุชูู ููุง ุจูุงุณุทุฉ ุฌุงูุงุณูุฑูุจุช -->
    </div>




    <!-- ููุฏุงู (ูุงูุฐุฉ ููุจุซูุฉ) ุนุงูุฉ -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <!-- ูุญุชูู ุงูููุฏุงู ุณูุชู ุญููู ููุง -->
        </div>
    </div>




    <!-- ============================================= -->
    <!-- ==== ุจุฏุงูุฉ ููุฏ ุฌุงูุงุณูุฑูุจุช ู Firebase ==== -->
    <!-- ============================================= -->
    <script type="module">
        // 1. ุงุณุชูุฑุงุฏ ูุธุงุฆู Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            Timestamp,
            updateDoc,
            runTransaction,
            getDocs,
            orderBy,
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";




        // 2. ุฅุนุฏุงุฏุงุช Firebase (ูู ุงููุณุชุฎุฏู)
        const firebaseConfig = {
          apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
          authDomain: "services-cef84.firebaseapp.com",
          databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
          projectId: "services-cef84",
          storageBucket: "services-cef84.firebasestorage.app",
          messagingSenderId: "902396219187",
          appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };




        // 3. ุชููุฆุฉ Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);




        // 4. ูุชุบูุฑุงุช ุงูุญุงูุฉ ุงูุนุงูุฉ
        let userId = null;
        let userProfile = null;
        let currentUnsubscribe = null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'services-cef84'; 




        let isRegistering = false; 
        let allUsers = []; 




        let navigationHistory = [];


        // === ุฅุถุงูุฉ ุซุงุจุช ููุญุฐู ุงูุชููุงุฆู (48 ุณุงุนุฉ) ===
        const AUTO_DELETE_MS = 48 * 60 * 60 * 1000;




        // === ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฎุฏูุงุช (ูุฃูุซุฑ ูู 100 ูููุฉ ูุชุนุฏูู ุงูุตูุงุบุฉ) ===
        const SERVICES_LIST = [
            // ููู ุญุฑููุฉ ูุฎุฏูุงุช ููุฒููุฉ (20)
            { name: 'ุณุจุงู', icon: '๐ง' },
            { name: 'ููุฑุจุงุฆู', icon: '๐ก' }, // ุชู ุงูุชุนุฏูู
            { name: 'ูุฌุงุฑ ููุจูููุง', icon: '๐ช' },
            { name: 'ููู ุชุจุฑูุฏ ูุชูููู', icon: 'โ๏ธ' },
            { name: 'ููุงุด ูุฏูุงูุงุช', icon: '๐จ' },
            { name: 'ููู ุตูุงูุฉ ุฃุฌูุฒุฉ ููุฑุจุงุฆูุฉ', icon: '๐' },
            { name: 'ููู ุตูุงูุฉ ุบุณุงูุงุช', icon: '๐งบ' },
            { name: 'ููู ุตูุงูุฉ ุซูุงุฌุงุช', icon: '๐ง' },
            { name: 'ุชุฑููุจ ุฏุด ูุณุชุงูุงูุช', icon: '๐ก' },
            { name: 'ุชูุธูู ููุงุฒู ูููุงุชุจ', icon: '๐งน' },
            { name: 'ููุงูุญุฉ ุญุดุฑุงุช', icon: '๐' },
            { name: 'ููู ุฃูู ุตูุงุนู', icon: '๐จ' },
            { name: 'ููู ูุตุงุนุฏ', icon: 'โฌ๏ธ' },
            { name: 'ููู ุบูุงูุงุช', icon: '๐ฅ' },
            { name: 'ููู ุชุฑููุจ ุจุงุฑููู', icon: '๐ชต' },
            { name: 'ููู ุชุฑููุจ ูุฑู ุญุงุฆุท', icon: '๐ผ๏ธ' },
            { name: 'ููู ุชุฑููุจ ุณุชุงุฆุฑ', icon: '๐ช' },
            { name: 'ููู ุชุฑููุจ ูุทุงุจุฎ ุฃููููุชุงู', icon: '๐ช' },
            { name: 'ููู ุชูุฌูุฏ ูุตุงูููุงุช', icon: '๐๏ธ' },
            { name: 'ููู ุชุฑููุจ ุฒุฌุงุฌ ูุณูููุฑูุช', icon: '๐' },




            // ููู ููุฏุณูุฉ ูุชูููุฉ (20)
            { name: 'ูููุฏุณ ูุฏูู (ุชูููุฐ)', icon: '๐๏ธ' },
            { name: 'ูููุฏุณ ูุนูุงุฑู (ุชุตููู)', icon: '๐' },
            { name: 'ูููุฏุณ ุดุจูุงุช', icon: '๐ถ' },
            { name: 'ูููุฏุณ ุจุฑูุฌูุงุช', icon: '๐ป' },
            { name: 'ูููุฏุณ ููุฑุจุงุก ููู', icon: 'โก' },
            { name: 'ูููุฏุณ ูููุงูููุง ุฅูุชุงุฌ', icon: '๐ญ' },
            { name: 'ูููุฏุณ ุฅููุชุฑูููุงุช', icon: '๐ฌ' },
            { name: 'ูููุฏุณ ุฒุฑุงุนู', icon: '๐พ' },
            { name: 'ูููุฏุณ ุฌูุฏุฉ', icon: 'โ' },
            { name: 'ูููุฏุณ ุจุชุฑูู', icon: '๐ข๏ธ' },
            { name: 'ุตูุงูุฉ ููุงุชู ูููุจููุชุฑ', icon: '๐ฑ' },
            { name: 'ููู ูุงููุฑุงุช ูุฑุงูุจุฉ', icon: '๐น' },
            { name: 'ูุฏุฎู ุจูุงูุงุช', icon: 'โจ๏ธ' },
            { name: 'ูุตูู ุฌุฑุงููู', icon: '๐จ' },
            { name: 'ูุทูุฑ ููุจ', icon: '๐' },
            { name: 'ุฎุจูุฑ ุฃูู ูุนูููุงุช', icon: '๐' },
            { name: 'ููู ุฏุนู ููู IT', icon: '๐' },
            { name: 'ููู ุทุจุงุนุฉ ูุชุตููุฑ', icon: '๐จ๏ธ' },
            { name: 'ููู ูุฎุชุจุฑุงุช', icon: '๐งช' },
            { name: 'ุฃุฎุตุงุฆู ุชุณููู ุฑููู', icon: '๐' },




            // ููู ูุงููุฉ ููุงููููุฉ ูุฅุฏุงุฑูุฉ (16)
            { name: 'ูุญุงุณุจ', icon: '๐ต' }, // ุชู ุงูุฅุถุงูุฉ
            { name: 'ูุญุงุณุจ ูุงูููู', icon: '๐งพ' },
            { name: 'ูุญุงุณุจ ุดุฑูุงุช', icon: '๐งฎ' },
            { name: 'ูุญุงุณุจ ุชูุงููู', icon: '๐ฐ' },
            { name: 'ูุญุงูู (ูุถุงูุง ูุฏููุฉ)', icon: 'โ๏ธ' },
            { name: 'ูุญุงูู (ูุถุงูุง ุฃุณุฑูุฉ)', icon: '๐' },
            { name: 'ูุญุงูู (ูุถุงูุง ุฌูุงุฆูุฉ)', icon: '๐ช' },
            { name: 'ูุฏูุฑ ููุชุจ/ุณูุฑุชูุฑ', icon: '๐' },
            { name: 'ููุธู ุงุณุชูุจุงู', icon: '๐๏ธ' },
            { name: 'ุฃููู ูุฎุฒู', icon: '๐ฆ' },
            { name: 'ููุฏูุจ ูุจูุนุงุช', icon: '๐ผ' },
            { name: 'ูุฏูุฑ ูุดุชุฑูุงุช', icon: '๐' },
            { name: 'ูุฏูุฑ ููุงุฑุฏ ุจุดุฑูุฉ', icon: '๐ฅ' },
            { name: 'ูุชุฑุฌู', icon: '๐' },
            { name: 'ูุฏูู ุญุณุงุจุงุช', icon: '๐' },
            { name: 'ูุณุชุดุงุฑ ูุงูู', icon: '๐ต' },




            // ููู ุทุจูุฉ ูุชูุฑูุถ (10)
            { name: 'ุทุจูุจ ุจุดุฑู', icon: 'โ๏ธ' },
            { name: 'ููุฑุถ ููุฒูู', icon: '๐ฉบ' },
            { name: 'ุตูุงุฏูู', icon: '๐' },
            { name: 'ูุณุนู', icon: '๐ฉน' },
            { name: 'ุทุจูุจ ุฃุณูุงู', icon: '๐ฆท' },
            { name: 'ุทุจูุจ ุจูุทุฑู', icon: '๐' },
            { name: 'ุฃุฎุตุงุฆู ุนูุงุฌ ุทุจูุนู', icon: '๐ถ' },
            { name: 'ุฃุฎุตุงุฆู ุชุบุฐูุฉ', icon: '๐' },
            { name: 'ููู ุฃุดุนุฉ', icon: 'โข๏ธ' },
            { name: 'ููู ุชุญุงููู ุทุจูุฉ', icon: '๐ฉธ' },




            // ููู ุชุนููููุฉ (5)
            { name: 'ูุฏุฑุณ ุฎุตูุตู', icon: 'โ๏ธ' },
            { name: 'ูุฏุฑุจ ุฑูุงุถู', icon: '๐ช' },
            { name: 'ูุฏุฑุจ ููุงุจ', icon: '๐' },
            { name: 'ูุฏุฑุจ ุชูููุฉ ุจุดุฑูุฉ', icon: '๐ง' },
            { name: 'ูุตุญุญ ูุบูู', icon: '๐' },




            // ููู ุงูุจูุงุก ูุงูุชุดููุฏ (10)
            { name: 'ุนุงูู ุจูุงุก', icon: '๐งฑ' },
            { name: 'ูุจูุถ ูุญุงุฑุฉ', icon: 'โฌ' },
            { name: 'ูุฑูุจ ุณูุฑุงููู ูุฑุฎุงู', icon: '๐จ' },
            { name: 'ุญุฏุงุฏ ูุณูุญ', icon: '๐' },
            { name: 'ุญุฏุงุฏ ูุฑูุชุงู', icon: '๐ก๏ธ' },
            { name: 'ุฃููููุชุงู ูุฒุฌุงุฌ', icon: '๐ช' },
            { name: 'ููู ุนุฒู ูุงุฆู ูุญุฑุงุฑู', icon: '๐ง' },
            { name: 'ููู ุชุฑููุจ ุฌุจุณ ุจูุฑุฏ', icon: '๐ก' },
            { name: 'ูุณุงุญ ุฃุฑุงุถู', icon: '๐' },
            { name: 'ููุงูู ุชุดุทูุจุงุช', icon: '๐' },




            // ููู ุงูุณูุงุฑุงุช ูุงูููู (10)
            { name: 'ููู ุณูุงุฑุงุช/ูููุงูููู', icon: 'โ๏ธ' },
            { name: 'ููู ููุฑุจุงุก ุณูุงุฑุงุช', icon: '๐' },
            { name: 'ูุนูู ุฏูุงู ุณูุงุฑุงุช', icon: '๐๏ธ' },
            { name: 'ุณุงุฆู ุฎุงุต', icon: '๐' },
            { name: 'ููู ุนูุด', icon: '๐' },
            { name: 'ุณุงุฆู ุดุงุญูุฉ/ููู ุซููู', icon: '๐' },
            { name: 'ููู ูุงูุชุด ูุจุทุงุฑูุงุช', icon: '๐' },
            { name: 'ููู ุณููุฑุฉ ุณูุงุฑุงุช', icon: '๐๏ธ' },
            { name: 'ููู ุบุณูู ูุชูููุน ุณูุงุฑุงุช', icon: '๐งผ' },
            { name: 'ุฎุฏูุงุช ุณูุงุญูุฉ ูุญุฌุฒ', icon: 'โ๏ธ' },




            // ููู ุงูุถูุงูุฉ ูุงูุฅุนูุงู (10)
            { name: 'ูุตูุฑ ููุชูุบุฑุงูู', icon: '๐ธ' },
            { name: 'ูุตูุฑ ููุฏูู', icon: '๐ฅ' },
            { name: 'ุทุจุงุฎ ููุงุณุจุงุช', icon: '๐งโ๐ณ' },
            { name: 'ุดูู ูุทุนู', icon: '๐ฝ๏ธ' },
            { name: 'ูุฐูุน/ูุนูู ุตูุชู', icon: '๐ค' },
            { name: 'ููุธู ุญููุงุช ูููุงุณุจุงุช', icon: '๐' },
            { name: 'ูุตูู ุดุนุฑ (ููุงููุฑ)', icon: '๐' },
            { name: 'ุฎูุงุท / ุชุฑุฒู', icon: '๐' },
            { name: 'ุฌููุณ ูุณููู', icon: '๐ง' },
            { name: 'ูุฑุจูุฉ ุฃุทูุงู', icon: '๐ถ' },




            // ููู ูุชููุนุฉ (10)
            { name: 'ุญุงุฑุณ ุฃูู', icon: '๐' },
            { name: 'ุจุงุฆุน/ูุงุดูุฑ', icon: '๐' },
            { name: 'ูุฒุงุฑุน/ุฌูุงููู', icon: '๐ฟ' },
            { name: 'ููู ุตูุงูุฉ ุขูุงุช ุตูุงุนูุฉ', icon: '๐ฉ' },
            { name: 'ุฃุฎุตุงุฆู ุชุฎุงุทุจ', icon: '๐ฃ๏ธ' },
            { name: 'ุฃุฎุตุงุฆู ููุณู', icon: '๐ง' },
            { name: 'ููู ุตูุงูุฉ ุฃุฌูุฒุฉ ุฑูุงุถูุฉ', icon: '๐๏ธ' },
            { name: 'ููู ุตูุงูุฉ ุฃุฌูุฒุฉ ุทุจุงุนุฉ', icon: '๐จ๏ธ' },
            { name: 'ุฃุฎุตุงุฆู ููุงุฑุฏ ุจูุฆูุฉ', icon: 'โป๏ธ' },
            { name: 'ุฃุฎุฑู (ููู ุญุฑุฉ/ุนุงูุฉ)', icon: '๐ฅ' },
        ]; // ุงูุฅุฌูุงูู: 106 ูููุฉ




        // ูุงุฆูุฉ ูุฑุงูุฒ ููุฏู ุงูุดุฑููุฉ
        const SHARQIA_CITIES = [
            "ุงูุฒูุงุฒูู", "ุจูุจูุณ", "ุงูุนุงุดุฑ ูู ุฑูุถุงู", "ุฃุจู ูุจูุฑ", "ูุงููุณ", "ูููุง ุงูููุญ", 
            "ุฏูุฑุจ ูุฌู", "ููุฑ ุตูุฑ", "ุฃุจู ุญูุงุฏ", "ุงููุฑูู", "ุงูููุงูุงุช", "ูุดุชูู ุงูุณูู", 
            "ูููุง", "ุงูุฅุจุฑุงููููุฉ", "ุฃููุงุฏ ุตูุฑ", "ุงูุตุงูุญูุฉ ุงูุฌุฏูุฏุฉ", "ุงูุญุณูููุฉ"
        ];




        // 5. ุฃููููุงุช SVG 
        const ICONS = {
            star: `<svg class="star-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`,
            starEmpty: `<svg class="star-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>`,
            home: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-3.741-5.582M11.995 12.75a9.004 9.004 0 0 1-5.214 0m-2.5 4.972a9.094 9.094 0 0 1 3.741-.479 3 3 0 0 1 3.741 5.582M12 12a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Zm-5.214 0a9.004 9.004 0 0 0 5.214 0M12 12a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9Zm5.214 0a9.004 9.004 0 0 0-5.214 0" /></svg>`,
            add: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`,
            profile: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`,
            chat: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72 3.72a.75.75 0 0 1-1.06 0l-3.72-3.72C9.847 17.1 9 16.136 9 15v-4.286c0-.97 0.616-1.813 1.5-2.097l6.75-3.375c.22-.11.459-.11.679 0l6.75 3.375Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5c.884-.284 1.5-1.128 1.5-2.097V7.116c0-1.136.847-2.1 1.98-2.193l3.72-3.72a.75.75 0 0 1 1.06 0l3.72 3.72C16.153 5.016 17 5.98 17 7.116v4.286c0 .97-.616 1.813-1.5 2.097l-6.75 3.375a.625.625 0 0 1-.679 0L3 13.5Z" /></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>`,
            back: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" /></svg>`, // RTL back arrow
            send: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Z" /></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 18.07a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.862 4.487Zm0 0L19.5 7.125" /></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.322 2.322 0 0 1 5.86 7.5v10.375A2.322 2.322 0 0 0 8.182 20.25h8.375A2.322 2.322 0 0 0 18.916 18V7.5a2.322 2.322 0 0 1-1.077-1.325M12 9.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" /></svg>`,
            job: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25M9 13.5h6" /></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.24 6.913m1.018 0h16.5M16.5 6.75h-9" /></svg>`,
        };




        // 6. ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ
        const appContainer = document.getElementById('app');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');




        // 7. ูุธุงุฆู ูุณุงุนุฏุฉ (Modal)
        function showModal(html) {
            modalContent.innerHTML = html;
            modalBackdrop.classList.remove('hidden');
        }




        function hideModal() {
            modalBackdrop.classList.add('hidden');
            modalContent.innerHTML = '';
        }




        function showLoading(message = 'ุฌุงุฑู ุงูุชุญููู...') {
            // ุงุณุชุฎุฏุงู Modal ููุชุญููู
            const html = `
                <div class="flex flex-col items-center justify-center p-6">
                    <svg class="animate-spin h-10 w-10 text-indigo-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-700 font-medium">${message}</p>
                </div>
            `;
            showModal(html);
        }




        function hideLoading() {
            hideModal();
        }




        function showMessageModal(title, message, isSuccess = true) {
            const color = isSuccess ? 'text-green-600' : 'text-red-600';
            const html = `
                <h2 class="text-xl font-semibold text-center ${color} mb-4">${title}</h2>
                <p class="text-center text-gray-700">${message}</p>
                <button data-action="closeModal" class="mt-4 w-full py-2 bg-indigo-800 text-white rounded-md hover:bg-indigo-700">ุญุณูุงู</button>
            `;
            showModal(html);
        }




        // ูุธููุฉ ูุณุงุนุฏุฉ ูุถุบุท ูุชุญููู ุงูุตูุฑุฉ ุฅูู Base64
        function resizeAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (readerEvent) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_SIZE = 400; 
                        let width = img.width;
                        let height = img.height;




                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }




                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);




                        // ุงูุชุญููู ุฅูู Base64 ูุน ุถุบุท ุงูุฌูุฏุฉ
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                        resolve(dataUrl); 
                    };
                    img.src = readerEvent.target.result;
                };
                reader.onerror = reject;
            });
        }


        // === ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุฐู ุงูุชููุงุฆู (48 ุณุงุนุฉ) ===
        async function attemptAutoDelete(docId, docData, collectionName) {
            if (!docData.createdAt || !docData.createdAt.toDate) return;




            const postTime = docData.createdAt.toDate().getTime();
            const currentTime = Date.now();


            if (currentTime - postTime > AUTO_DELETE_MS) {
                console.log(`Attempting to auto-delete old post (${collectionName}): ${docId}`);
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
                    await deleteDoc(docRef);
                    console.log(`Successfully auto-deleted: ${docId}`);
                    return true; // ุชู ุงูุญุฐู
                } catch (error) {
                    console.error(`Error during auto-delete of ${docId} in ${collectionName}:`, error);
                    return true; // ููุชุฑุถ ุฃูู ุชู ุงูุชุนุงูู ูุนู ุฃู ูุง ูููู ุงููุตูู ุฅููู
                }
            }
            return false; // ูู ูุชู ุงูุญุฐู
        }




        // 8. ูุธุงุฆู ุงูุชูุฌูู (Routing) 
        function navigateTo(page, params = {}) {
            console.log(`Navigating to: ${page}`, params);
            if (currentUnsubscribe) {
                currentUnsubscribe();
                currentUnsubscribe = null;
                console.log('Unsubscribed from real-time listener.');
            }




            const newRoute = { page, params };
            if (page !== 'loading' && page !== 'auth' && page !== 'register') {
                const lastRoute = navigationHistory[navigationHistory.length - 1];
                if (!lastRoute || lastRoute.page !== page || JSON.stringify(lastRoute.params) !== JSON.stringify(params)) {
                    navigationHistory.push(newRoute);
                    if(navigationHistory.length > 20) {
                        navigationHistory.shift();
                    }
                }
            } else if (page === 'auth' || page === 'register') {
                navigationHistory = [];
                navigationHistory.push(newRoute);
            }




            appContainer.innerHTML = ''; 
            window.scrollTo(0, 0);




            // ุชุญุฏูุซ ุนููุงู ุงูุตูุญุฉ
            document.title = getPageTitle(page);




            switch (page) {
                case 'loading':
                    renderLoadingScreen();
                    break;
                case 'auth':
                    renderAuthPage();
                    break;
                case 'register':
                    renderRegisterPage();
                    break;
                case 'clientHome':
                    renderClientHome();
                    break;
                case 'providerHome':
                    renderProviderHome();
                    break;
                case 'category':
                    renderCategoryPage(params.category);
                    break;
                case 'directory':
                    renderDirectoryPage();
                    break;
                case 'chatList':
                    renderChatListPage();
                    break;
                case 'profile':
                    renderProfilePage(params.uid);
                    break;
                case 'editProfile': 
                    renderEditProfilePage();
                    break;
                case 'chat':
                    renderChatPage(params.otherUserId);
                    break;
                case 'newRequest':
                    renderNewRequestPage();
                    break;
                case 'jobListings':
                    renderJobListingsPage();
                    break;
                case 'jobPosting':
                    renderJobPostingPage();
                    break;
                case 'myPostings': 
                    renderMyPostingsPage();
                    break;
                default:
                    renderAuthPage(); 
            }
        }




        function getPageTitle(page) {
            switch(page) {
                case 'auth': return 'ุชุณุฌูู ุงูุฏุฎูู - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'register': return 'ุฅูุดุงุก ุญุณุงุจ - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'clientHome':
                case 'providerHome': return 'ุงูุฑุฆูุณูุฉ - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'directory': return 'ุฏููู ุงููุณุชุฎุฏููู - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'chatList': return 'ุงููุญุงุฏุซุงุช - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'jobListings': return 'ุงููุธุงุฆู ุงููุชุงุญุฉ - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'myPostings': return 'ุฅุนูุงูุงุชู ูุทูุจุงุชู - ูุณุชูุจู ุงูุดุฑููุฉ';
                case 'profile': return 'ุงูููู ุงูุดุฎุตู - ูุณุชูุจู ุงูุดุฑููุฉ';
                default: return 'ูุณุชูุจู ุงูุดุฑููุฉ';
            }
        }




        // 9. ูุธุงุฆู ุนุฑุถ ุงูุตูุญุงุช (Render Functions)




        function renderLoadingScreen() {
            appContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="flex flex-col items-center">
                        <svg class="animate-spin h-12 w-12 text-indigo-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h1 class="text-xl font-semibold text-gray-700">ุฌุงุฑู ุชููุฆุฉ ุงูุชุทุจูู...</h1>
                    </div>
                </div>
            `;
        }




        function renderAuthPage() {
            appContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-4 bg-indigo-800">
                    <h1 class="text-4xl font-bold text-white mb-4">ูุณุชูุจู ุงูุดุฑููุฉ</h1>
                    <p class="text-lg text-indigo-100 mb-8 text-center">ุฃููุงู ุจู ูู ุชุทุจูู ุฎุฏูุงุช ูุญุงูุธุฉ ุงูุดุฑููุฉ</p>
                    
                    <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6">
                        <form id="login-form" class="space-y-4">
                            <h2 class="text-2xl font-semibold text-center text-gray-800 mb-4">ุชุณุฌูู ุงูุฏุฎูู</h2>
                            <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <div>
                                <label for="login-identifier" class="block text-sm font-medium text-gray-700">ุงุณู ุงููุณุชุฎุฏู</label>
                                <input type="text" id="login-identifier" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ุงุฏุฎู ุงุณู ุงููุณุชุฎุฏู">
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-gray-700">ูููุฉ ุงููุฑูุฑ</label>
                                <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="********">
                            </div>
                            <button type="submit" data-action="login" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                ุฏุฎูู
                            </button>
                        </form>
                        
                        <div class="my-4 flex items-center justify-center">
                            <span class="border-t border-gray-300 flex-grow"></span>
                            <span class="px-4 text-sm text-gray-500">ุฃู</span>
                            <span class="border-t border-gray-300 flex-grow"></span>
                        </div>
                        
                        <button data-action="navigateTo" data-page="register" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
                        </button>
                    </div>
                </div>
            `;
        }




        function renderRegisterPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');




            const cityOptions = SHARQIA_CITIES.map(city => 
                `<option value="${city}">${city}</option>`
            ).join('');




            appContainer.innerHTML = `
                <div class="min-h-screen main-padding bg-gray-50">
                    <h1 class="text-2xl font-bold text-gray-900 mb-6 text-center">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</h1>
                    <form id="register-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                        <div id="register-error" class="text-red-500 text-sm text-center hidden"></div>
                        
                        <!-- ุญูู ุงูุตูุฑุฉ ูุฑูุนูุง ุจุงูุถุบุท -->
                        <div>
                            <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                            <label for="photo-upload-input" class="block text-sm font-medium text-gray-700 text-center cursor-pointer">
                                ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ (ุงุฎุชูุงุฑู)
                                <div class="mt-2 flex flex-col items-center justify-center">
                                    <img id="photo-preview" class="w-24 h-24 rounded-full object-cover border-2 border-gray-300 p-1 hover:border-indigo-500 transition-colors" 
                                         src="https://placehold.co/100x100/EBF8FF/3182CE?text=User" alt="ุตูุฑุฉ ุงูุชุฑุงุถูุฉ">
                                    <span class="text-xs text-indigo-500 mt-2 hover:underline">ุงุถุบุท ูุฑูุน ุตูุฑุชู</span>
                                </div>
                            </label>
                            <input type="hidden" id="photo-base64" value="">
                        </div>
                        
                        <hr class="my-3">
                        
                        <div>
                            <label for="register-username" class="block text-sm font-medium text-gray-700">ุงุณู ุงููุณุชุฎุฏู</label>
                            <input type="text" id="register-username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: myname123">
                        </div>
                        
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700">ูููุฉ ุงููุฑูุฑ (6 ุญุฑูู ุฃู ุฃุฑูุงู ุนูู ุงูุฃูู)</label>
                            <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="********">
                        </div>
                        
                        <hr class="my-3">
                        
                        <div>
                            <label for="register-name" class="block text-sm font-medium text-gray-700">ุงูุงุณู ุงููุงูู</label>
                            <input type="text" id="register-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: ูุญูุฏ ุฃุญูุฏ ุนูู">
                        </div>
                        <div>
                            <label for="register-phone" class="block text-sm font-medium text-gray-700">ุฑูู ุงููุงุชู (11 ุฑูู)</label>
                            <input type="tel" id="register-phone" required pattern="[0-9]{11}" maxlength="11" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: 01012345678">
                        </div>
                        
                        <!-- === ุฅุตูุงุญ 3: ุงุฎุชูุงุฑ ุงูุฌูุณ === -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ุงูุฌูุณ</label>
                            <div class="mt-1 flex space-x-4 space-x-reverse">
                                <label class="flex items-center">
                                    <input type="radio" name="gender" value="ุฐูุฑ" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" required>
                                    <span class="mr-2 text-gray-700 text-sm">ุฐูุฑ</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="gender" value="ุฃูุซู" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" required>
                                    <span class="mr-2 text-gray-700 text-sm">ุฃูุซู</span>
                                </label>
                            </div>
                        </div>




                        
                        <!-- ุชูุณูู ุงูุนููุงู -->
                        <div>
                            <label for="register-city" class="block text-sm font-medium text-gray-700">ุงููุฑูุฒ / ุงููุฏููุฉ</label>
                            <select id="register-city" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                <option value="">ุงุฎุชุฑ ุงููุฑูุฒ/ุงููุฏููุฉ</option>
                                ${cityOptions}
                            </select>
                        </div>
                        <div>
                            <label for="register-area" class="block text-sm font-medium text-gray-700">ุงูููุทูุฉ / ุชูุงุตูู ุงูุนููุงู</label>
                            <input type="text" id="register-area" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: ุงูููููุฉุ ุดุงุฑุน 33">
                        </div>
                        
                        <hr class="my-3">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ุฃุฑุบุจ ูู ุงูุชุณุฌูู ูู:</label>
                            <div class="mt-2 flex space-x-4 space-x-reverse">
                                <label class="flex items-center">
                                    <input type="radio" name="role" value="client" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                    <span class="mr-2 text-gray-700 text-sm">ุนููู</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="role" value="provider" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <span class="mr-2 text-gray-700 text-sm">ููุฏู ุฎุฏูุฉ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="job-title-field" class="hidden space-y-4">
                            <div>
                                <label for="register-job-select" class="block text-sm font-medium text-gray-700">ุงุฎุชุฑ ูุธููุชู / ุงูุฎุฏูุฉ:</label>
                                <select id="register-job-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                    <option value="">ุงุฎุชุฑ...</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" data-action="register" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            ุฅูุดุงุก ุงูุญุณุงุจ
                        </button>
                        
                        <p class="text-center text-xs text-gray-600">
                            ูู ูุฏูู ุญุณุงุจ ุจุงููุนูุ 
                            <button type="button" data-action="navigateTo" data-page="auth" class="font-medium text-indigo-600 hover:text-indigo-500">
                                ุณุฌู ุงูุฏุฎูู
                            </button>
                        </p>
                    </form>
                </div>
            `;




            // ุชููุฆุฉ ูุณุชูุน ุญุฏุซ ุฑูุน ุงูุตูุฑุฉ
            document.getElementById('photo-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;




                showLoading('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุตูุฑุฉ...');
                try {
                    const base64Image = await resizeAndConvertImage(file);
                    document.getElementById('photo-preview').src = base64Image;
                    document.getElementById('photo-base64').value = base64Image;
                } catch (error) {
                    console.error("Image processing error:", error);
                    showMessageModal('ุฎุทุฃ ูู ุงูุตูุฑุฉ', 'ูู ูุชููู ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ุจุตูุฑุฉ ุฃุฎุฑู.', false);
                } finally {
                    hideLoading();
                }
            });
        }




        function renderClientHome() {
            const categoriesHtml = SERVICES_LIST.map(cat => `
                <div data-action="navigateTo" data-page="category" data-category="${cat.name.toLowerCase()}" 
                     class="flex flex-col items-center justify-center bg-indigo-50 p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-indigo-200 hover:border-indigo-500">
                    <span class="text-3xl mb-1">${cat.icon}</span>
                    <h3 class="text-xs font-semibold text-gray-800 text-center">${cat.name}</h3>
                </div>
            `).join('');




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white welcome-header shadow-md sticky top-0 z-10">
                        <h1 class="text-lg font-bold">ุฃููุงู ุจูุ ${userProfile.name}</h1>
                        <p class="text-indigo-100 text-xs">ุงุจุญุซ ุนู ุงูุฎุฏูุฉ ุงูุชู ุชุญุชุงุฌูุง ูู ูุญุงูุธุฉ ุงูุดุฑููุฉ</p>
                    </header>
                    
                    <main class="main-padding">
                        <h2 class="text-base font-semibold text-gray-900 mb-4">ุฃูุณุงู ุงูุฎุฏูุงุช ุงููุชุงุญุฉ</h2>
                        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${categoriesHtml}
                        </div>
                    </main>
                    
                    <button data-action="navigateTo" data-page="newRequest" 
                            class="fixed bottom-16 left-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-30 hover:bg-indigo-700 transition-colors">
                        ${ICONS.add}
                    </button>
                    
                    ${renderBottomNav('home')}
                </div>
            `;
        }




        // === ุฏุงูุฉ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูููุฏู ุงูุฎุฏูุฉ (ุชู ุชุนุฏูู ุงูุงุณุชุนูุงู ูุงููุฑุฒ) ===
        async function renderProviderHome() {
            const categoriesHtml = SERVICES_LIST.map(cat => `
                <div data-action="navigateTo" data-page="category" data-category="${cat.name.toLowerCase()}" 
                     class="flex flex-col items-center justify-center bg-indigo-50 p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-indigo-200 hover:border-indigo-500">
                    <span class="text-3xl mb-1">${cat.icon}</span>
                    <h3 class="text-xs font-semibold text-gray-800 text-center">${cat.name}</h3>
                </div>
            `).join('');




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white welcome-header shadow-md sticky top-0 z-10">
                        <h1 class="text-lg font-bold">ุฃููุงู ุจูุ ${userProfile.name}</h1>
                        <p class="text-indigo-100 text-xs">ุชุตูุญ ุทูุจุงุช ุงูุฎุฏูุงุช ุงููุชุงุญุฉ ุฃู ุงุทูุจ ุฎุฏูุฉ ุจููุณู</p>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <!-- ุทูุจุงุช ุงูุฎุฏูุงุช ุงููุชุงุญุฉ (ูููุธููุฉ ุงูุฎุงุตุฉ ุจู) -->
                        <h2 class="text-base font-semibold text-gray-900 mb-4">ุทูุจุงุช ูุธููุฉ ${userProfile.jobTitle || 'ุบูุฑ ูุญุฏุฏุฉ'} ุงููุชุงุญุฉ</h2>
                        <div id="requests-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุชุญููู ุงูุทูุจุงุช...</p>
                        </div>
                        
                        <!-- ุฃูุณุงู ุงูุฎุฏูุงุช (ููุชููู ูู ุทูุจ ุฎุฏูุฉ ูุนููู) -->
                        <h2 class="text-base font-semibold text-gray-900 mt-6 mb-4 border-t pt-4">ุงุทูุจ ุฎุฏูุฉ ุฃู ุชุตูุญ ุงูุฃูุณุงู</h2>
                        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${categoriesHtml}
                        </div>
                    </main>
                    
                    <button data-action="navigateTo" data-page="newRequest" 
                            class="fixed bottom-16 left-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-30 hover:bg-indigo-700 transition-colors">
                        ${ICONS.add}
                    </button>
                    
                    ${renderBottomNav('home')}
                </div>
            `;




            const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);




            // 1. ุจุญุซ ุนู ุงูุทูุจุงุช ุงูุชู ุชุชุทุงุจู ูุน ูุธููุฉ ููุฏู ุงูุฎุฏูุฉ (ุจุฏูู orderBy)
            const jobSpecificQuery = query(requestsColRef, where('category', '==', userProfile.jobTitle));




            currentUnsubscribe = onSnapshot(jobSpecificQuery, async (snapshot) => {
                const requestsList = document.getElementById('requests-list');
                let requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));


                // === ุชุทุจูู ุงูุญุฐู ุงูุชููุงุฆู ===
                const validRequests = [];
                for (const req of requests) {
                    const isDeleted = await attemptAutoDelete(req.id, req, 'serviceRequests');
                    if (!isDeleted) {
                        validRequests.push(req);
                    }
                }
                requests = validRequests;


                // === ุงููุฑุฒ ุงููุฏูู (Client-Side Sorting) ===
                requests.sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return timeB - timeA;
                });




                if (requests.length === 0) {
                    // 2. ุฅุฐุง ูู ูุฌุฏ ุทูุจุงุช ููุธููุชูุ ูุนุฑุถ ุฑุณุงูุฉ "ูุง ุชูุฌุฏ ุทูุจุงุช ุฎุฏูุฉ ูุชุงุญุฉ ุญุงููุงู"
                    requestsList.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ูุง ุชูุฌุฏ ุทูุจุงุช ุฎุฏูุฉ ูุชุงุญุฉ ุญุงููุงู ููุธููุฉ ' + (userProfile.jobTitle || 'ุบูุฑ ูุญุฏุฏุฉ') + '.</p>';
                } else {
                    requestsList.innerHTML = generateRequestList(requests);
                }
            }, (error) => {
                console.error("Error fetching requests: ", error);
                document.getElementById('requests-list').innerHTML = '<p class="text-red-500 p-6 bg-white rounded-lg shadow-sm">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุทูุจุงุช.</p>';
            });




            function generateRequestList(requests, emptyMessage = `ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู ููุธููุฉ ${userProfile.jobTitle || 'ุบูุฑ ูุญุฏุฏุฉ'}.`) {
                 if (requests.length === 0) {
                     return `<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">${emptyMessage}</p>`;
                 }
                return requests.map(req => {
                    const dateString = req.createdAt && req.createdAt.toDate ? new Date(req.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ุชุงุฑูุฎ ุบูุฑ ูุญุฏุฏ';
                    return `
                    <div class="bg-indigo-50 p-4 rounded-lg shadow-md border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <img data-action="navigateTo" data-page="profile" data-uid="${req.requesterId}"
                                     src="${req.requesterPhoto || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                     alt="${req.requesterName}" class="w-10 h-10 rounded-full object-cover cursor-pointer">
                                <div>
                                    <h4 data-action="navigateTo" data-page="profile" data-uid="${req.requesterId}" 
                                        class="font-semibold text-gray-800 text-sm cursor-pointer hover:text-indigo-600">${req.requesterName}</h4>
                                    <p class="text-xs text-gray-500">ุทูุจ ุฎุฏูุฉ: ${req.category}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${dateString}</span>
                        </div>
                        <h3 class="text-base font-semibold text-gray-900 mb-1">${req.title}</h3>
                        <p class="text-sm text-gray-600 mb-3">${req.description.substring(0, 100)}...</p>
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${req.requesterId}"
                                class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors">
                            ุชูุงุตู ูุน ุงูุนููู
                        </button>
                    </div>
                `}).join('');
            }
        }




        async function renderCategoryPage(categoryName) {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-lg font-bold">ููุฏูู ุฎุฏูุฉ: ${categoryName || 'ูู ุงูุฎุฏูุงุช'}</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="providers-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุงูุจุญุซ ุนู ููุฏูู ุฎุฏูุงุช...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('home')}
                </div>
            `;




            const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
            const allProvidersQuery = query(usersColRef, where('role', '==', 'provider'));




            currentUnsubscribe = onSnapshot(allProvidersQuery, (snapshot) => {
                const providersListEl = document.getElementById('providers-list');




                // === ุงูุจุญุซ ุจุงุณุชุฎุฏุงู ุงุณู ุงููุธููุฉ ูู ุญูู jobTitleSearch ===
                const providers = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(p => !categoryName || (p.jobTitle && p.jobTitle.toLowerCase().includes(categoryName))); 




                if (providers.length === 0) {
                    providersListEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ูุง ููุฌุฏ ููุฏูู ุฎุฏูุงุช ูุณุฌููู ูู ูุฐุง ุงููุณู ุญุงููุงู.</p>';
                    return;
                }




                providersListEl.innerHTML = providers.map(p => {
                    const avgRating = p.avgRating ? p.avgRating.toFixed(1) : 'ุฌุฏูุฏ';
                    const ratingCount = p.ratings ? p.ratings.length : 0;




                    return `
                    <div class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse">
                        <img data-action="navigateTo" data-page="profile" data-uid="${p.uid}"
                             src="${p.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${p.name}" class="w-12 h-12 rounded-full object-cover cursor-pointer">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <h3 data-action="navigateTo" data-page="profile" data-uid="${p.uid}"
                                    class="text-base font-semibold text-gray-900 cursor-pointer hover:text-indigo-600">${p.name}</h3>
                                <div class="flex items-center text-yellow-500 text-xs">
                                    <span class="font-bold mr-1">${avgRating}</span>
                                    ${ICONS.star}
                                    <span class="text-xs text-gray-500 ms-1">(${ratingCount})</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 truncate-1-line">${p.jobTitle}</p>
                            <p class="text-xs text-gray-500">${p.addressCity || p.address} - ${p.addressArea || ''}</p>
                        </div>
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${p.uid}"
                                class="flex-shrink-0 bg-indigo-100 text-indigo-700 py-1.5 px-3 rounded-md text-sm font-medium hover:bg-indigo-200 transition-colors">
                            ุชูุงุตู
                        </button>
                    </div>
                `}).join('');
            }, (error) => {
                console.error("Error fetching providers: ", error);
                document.getElementById('providers-list').innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ููุฏูู ุงูุฎุฏูุงุช.</p>';
            });
        }




        async function renderDirectoryPage() {
            function renderUserList(users) {
                const listEl = document.getElementById('directory-list');
                const searchInput = document.getElementById('search-directory');
                const searchText = searchInput ? searchInput.value.toLowerCase() : '';




                const filteredUsers = users.filter(user => 
                    user.name.toLowerCase().includes(searchText) || 
                    (user.jobTitle && user.jobTitle.toLowerCase().includes(searchText)) ||
                    (user.username && user.username.toLowerCase().includes(searchText))
                );




                if (filteredUsers.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ูู ูุชู ุงูุนุซูุฑ ุนูู ูุณุชุฎุฏููู ูุทุงุจููู ููุชุงุฆุฌ ุงูุจุญุซ.</p>';
                    return;
                }




                listEl.innerHTML = filteredUsers.map(user => {
                    const userRole = user.role === 'provider' ? (user.jobTitle || 'ููุฏู ุฎุฏูุฉ') : 'ุนููู';
                    const userColor = user.role === 'provider' ? 'text-indigo-600' : 'text-green-600';
                    return `
                    <div data-action="navigateTo" data-page="profile" data-uid="${user.uid}" 
                         class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse cursor-pointer hover:bg-indigo-100 transition-colors">
                        <img src="${user.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${user.name}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <h3 class="text-base font-semibold text-gray-900">${user.name}</h3>
                            <p class="text-sm ${userColor} font-medium">${userRole}</p>
                            <p class="text-xs text-gray-500">${user.phone}</p>
                        </div>
                    </div>
                    `
                }).join('');
            }




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10">
                        <h1 class="text-xl font-bold mb-0">ุฏููู ุงููุณุชุฎุฏููู</h1>
                        <input type="text" id="search-directory" class="w-full px-4 py-1.5 border border-indigo-500 rounded-lg focus:outline-none focus:ring-1 focus:ring-white focus:border-white text-sm text-gray-900 mt-2" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุงููุธููุฉ...">
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="directory-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุชุญููู ุงููุณุชุฎุฏููู...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('directory')}
                </div>
            `;




            const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);




            const unsubscribeDirectory = onSnapshot(usersColRef, (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserList(allUsers); 
            }, (error) => {
                console.error("Error fetching all users: ", error);
                document.getElementById('directory-list').innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงููุณุชุฎุฏููู.</p>';
            });




            currentUnsubscribe = unsubscribeDirectory;




            document.getElementById('search-directory').addEventListener('input', () => {
                renderUserList(allUsers);
            });
        }




        async function renderChatListPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10">
                        <h1 class="text-xl font-bold">ุงููุญุงุฏุซุงุช</h1>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="chat-list-container" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุชุญููู ุงููุญุงุฏุซุงุช...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('chatList')}
                </div>
            `;




            const chatsColRef = collection(db, `artifacts/${appId}/public/data/chats`);
            const q = query(chatsColRef, where('users', 'array-contains', userId));




            currentUnsubscribe = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('chat-list-container');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ูุง ุชูุฌุฏ ูุฏูู ูุญุงุฏุซุงุช ุญุชู ุงูุขู.</p>';
                    return;
                }




                const chats = snapshot.docs.map(doc => doc.data());
                chats.sort((a, b) => b.lastUpdate.toMillis() - a.lastUpdate.toMillis());




                listEl.innerHTML = chats.map(chat => {
                    const otherUserId = chat.users.find(uid => uid !== userId);
                    if (!chat.userDetails || !chat.userDetails[otherUserId]) {
                        return ''; 
                    }
                    const otherUser = chat.userDetails[otherUserId];




                    return `
                    <div data-action="navigateTo" data-page="chat" data-otheruserid="${otherUserId}"
                         class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse cursor-pointer hover:bg-indigo-100 transition-colors">
                        <img src="${otherUser.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${otherUser.name}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1 overflow-hidden">
                            <h3 class="text-base font-semibold text-gray-900 truncate-1-line">${otherUser.name}</h3>
                            <p class="text-sm text-gray-600 truncate-1-line">${chat.lastMessage}</p>
                        </div>
                        <span class="text-xs text-gray-400 flex-shrink-0">${new Date(chat.lastUpdate.toDate()).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                    `;
                }).join('');




            }, (error) => {
                console.error("Error fetching chat list: ", error);
                document.getElementById('chat-list-container').innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงููุญุงุฏุซุงุช.</p>';
            });
        }




        async function renderProfilePage(uid) {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ุงูููู ุงูุดุฎุตู</h1>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            ${uid === userId ? `
                                <!-- === ุชุนุฏูู ูุงุฌูุฉ ุงูุชุญุฑูุฑ (ุงูุฎุงุตูุฉ ุฑูู 3) === -->
                                <button data-action="navigateTo" data-page="editProfile"
                                        class="flex items-center space-x-1 space-x-reverse p-1 text-white hover:text-indigo-100 rounded-md transition-colors cursor-pointer">
                                    ${ICONS.edit}
                                    <span class="text-sm font-medium">ุงุถุบุท ูุชุนุฏูู ุจุฑููุงููู</span>
                                </button>
                            ` : ''}
                            <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                                ${ICONS.back}
                            </button>
                        </div>
                    </header>
                    
                    <main id="profile-content" class="main-padding bg-gray-50">
                        <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุชุญููู ุงูููู ุงูุดุฎุตู...</p>
                    </main>
                    
                    ${renderBottomNav(uid === userId ? 'profile' : '')}
                </div>
            `;




            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
                const userDoc = await getDoc(userDocRef);




                if (!userDoc.exists()) {
                    document.getElementById('profile-content').innerHTML = '<p class="text-red-500">ูุฐุง ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ.</p>';
                    return;
                }




                const profileData = userDoc.data();




                const ratings = profileData.ratings || [];
                const avgRating = profileData.avgRating ? profileData.avgRating.toFixed(1) : 0;
                const ratingCount = ratings.length;




                const clientRatings = profileData.clientRatings || [];
                const clientAvgRating = clientRatings.length > 0 ? (clientRatings.reduce((acc, r) => acc + r.stars, 0) / clientRatings.length).toFixed(1) : 0;
                const clientRatingCount = clientRatings.length;




                const profileContent = document.getElementById('profile-content');
                profileContent.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col items-center">
                        <img src="${profileData.photoURL || 'https://placehold.co/150x150/EBF8FF/3182CE?text=User'}" 
                             alt="${profileData.name}" class="w-28 h-28 rounded-full object-cover shadow-lg border-4 border-white mb-3">
                        <h2 class="text-2xl font-bold text-gray-900">${profileData.name}</h2>
                        ${profileData.role === 'provider' ? 
                            `<p class="text-lg text-indigo-600 font-medium mt-1">${profileData.jobTitle || 'ููุฏู ุฎุฏูุฉ'}</p>` : 
                            '<p class="text-lg text-green-600 font-medium mt-1">ุนููู</p>'
                        }
                        
                        ${uid !== userId ? `
                            <button data-action="navigateTo" data-page="chat" data-otheruserid="${uid}"
                                    class="mt-4 bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-700 transition-colors">
                                ุชูุงุตู ุงูุขู
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ุจูุงูุงุช ุงูุชูุงุตู</h3>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">๐ค</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">ุงุณู ุงููุณุชุฎุฏู</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.username || 'N/A'}</span>
                                </div>
                            </div>
                            <!-- === ุนุฑุถ ุงูุฌูุณ === -->
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">๐ป</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">ุงูุฌูุณ</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.gender || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">๐</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">ุงูุฑูู</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.phone}</span>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">๐</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">ุงูุนููุงู</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.addressCity}ุ ${profileData.addressArea}</span>
                                </div>
                            </div>
                        </div>
                    </div>




                    <!-- ุชูููู ููุฏู ุงูุฎุฏูุฉ (ุฅุฐุง ูุงู ููุฏู ุฎุฏูุฉ) -->
                    ${profileData.role === 'provider' ? `
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ุชููููุงุช ุงูุฎุฏูุงุช ุงูุชู ูุฏููุง (${ratingCount})</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-bold text-yellow-500">${avgRating}</span>
                            <span class="text-xl text-gray-400 mx-2">/</span>
                            <span class="text-xl text-gray-400">5</span>
                            <div class="flex mr-4">
                                ${renderStarRating(avgRating, 5, 'h-6 w-6 text-yellow-400')}
                            </div>
                        </div>
                        
                        <div id="ratings-list" class="space-y-3 max-h-48 overflow-y-auto no-scrollbar text-sm">
                            ${ratings.length > 0 ? ratings.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(r => `
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${r.byName || 'ูุณุชุฎุฏู'}</span>
                                        <div class="flex text-yellow-400">
                                            ${renderStarRating(r.stars, 5, 'h-4 w-4')}
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-1">${r.comment}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">ูุง ุชูุฌุฏ ุชููููุงุช ุจุนุฏ.</p>'}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ุชูููู ุงูุนููู (ุฅุฐุง ูุงู ุนููู) === ุฅุตูุงุญ 3 === -->
                    ${profileData.role === 'client' ? `
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ุชููููุงุช ุงูุนููู ูู ููุฏูู ุงูุฎุฏูุงุช (${clientRatingCount})</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-bold text-yellow-500">${clientAvgRating}</span>
                            <span class="text-xl text-gray-400 mx-2">/</span>
                            <span class="text-xl text-gray-400">5</span>
                            <div class="flex mr-4">
                                ${renderStarRating(clientAvgRating, 5, 'h-6 w-6 text-yellow-400')}
                            </div>
                        </div>
                        
                        <div id="client-ratings-list" class="space-y-3 max-h-48 overflow-y-auto no-scrollbar text-sm">
                            ${clientRatings.length > 0 ? clientRatings.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(r => `
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${r.byName || 'ูุณุชุฎุฏู'}</span>
                                        <div class="flex text-yellow-400">
                                            ${renderStarRating(r.stars, 5, 'h-4 w-4')}
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-1">${r.comment}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">ูุง ุชูุฌุฏ ุชููููุงุช ุจุนุฏ.</p>'}
                        </div>
                    </div>
                    ` : ''}




                    
                    ${uid === userId ? `
                        <!-- === ุฅุถุงูุฉ ุฒุฑ ุนุฑุถ ุงูุฅุนูุงูุงุช ูุงูุทูุจุงุช (ุงูุฎุงุตูุฉ ุฑูู 1) === -->
                        <button data-action="navigateTo" data-page="myPostings" 
                                class="mt-6 w-full bg-indigo-100 text-indigo-700 py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-200 transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                            ${ICONS.job}
                            <span>ุนุฑุถ ุฅุนูุงูุงุชู ูุทูุจุงุชู</span>
                        </button>


                        <button data-action="logout" 
                                class="mt-3 w-full bg-red-100 text-red-700 py-2 px-6 rounded-lg font-semibold text-base hover:bg-red-200 transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                            ${ICONS.logout}
                            <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                        </button>
                    ` : ''}
                `;




            } catch (error) {
                console.error("Error fetching profile: ", error);
                document.getElementById('profile-content').innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูููู ุงูุดุฎุตู.</p>';
            }
        }


        // === ุฏุงูุฉ ุนุฑุถ ุฅุนูุงูุงุช ูุทูุจุงุช ุงููุณุชุฎุฏู (ุชู ุชุนุฏูู ุงูุงุณุชุนูุงู ูุงููุฑุฒ) ===
        async function renderMyPostingsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ุฅุนูุงูุงุชู ูุทูุจุงุชู</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="my-postings-list" class="space-y-4">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุชุญููู ุฅุนูุงูุงุชู ูุทูุจุงุชู...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('profile')}
                </div>
            `;


            const listEl = document.getElementById('my-postings-list');
            showLoading('ุฌุงุฑู ุชุญููู ุจูุงูุงุชู...');


            try {
                // 1. ุฌูุจ ุทูุจุงุช ุงูุฎุฏูุงุช (Service Requests) - ุชู ุญุฐู orderBy
                const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
                // ุงูุงุณุชุนูุงู ุงูุฌุฏูุฏ: where ููุท
                const requestsQuery = query(requestsColRef, where('requesterId', '==', userId)); 
                const requestsSnapshot = await getDocs(requestsQuery);


                let requests = requestsSnapshot.docs.map(doc => ({ id: doc.id, type: 'request', ...doc.data() }));


                // ุชุทุจูู ุงูุญุฐู ุงูุชููุงุฆู ุนูู ุงูุทูุจุงุช
                const validRequests = [];
                for (const req of requests) {
                    const isDeleted = await attemptAutoDelete(req.id, req, 'serviceRequests');
                    if (!isDeleted) {
                        validRequests.push(req);
                    }
                }
                requests = validRequests;




                // 2. ุฌูุจ ุฅุนูุงูุงุช ุงููุธุงุฆู (Job Postings) - ุชู ุญุฐู orderBy
                const jobsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
                // ุงูุงุณุชุนูุงู ุงูุฌุฏูุฏ: where ููุท
                const jobsQuery = query(jobsColRef, where('posterId', '==', userId));
                const jobsSnapshot = await getDocs(jobsQuery);


                let jobs = jobsSnapshot.docs.map(doc => ({ id: doc.id, type: 'job', ...doc.data() }));


                // ุชุทุจูู ุงูุญุฐู ุงูุชููุงุฆู ุนูู ุฅุนูุงูุงุช ุงููุธุงุฆู
                const validJobs = [];
                for (const job of jobs) {
                    const isDeleted = await attemptAutoDelete(job.id, job, 'jobPostings');
                    if (!isDeleted) {
                        validJobs.push(job);
                    }
                }
                jobs = validJobs;


                // 3. ุฏูุฌ ูุชุฑุชูุจ ุงููู ูุฏููุงู ูู ุงูููุฏ (Client-Side Sorting)
                const allPostings = [...requests, ...jobs].sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return timeB - timeA; // ูุฑุฒ ุชูุงุฒูู (ุงูุฃุญุฏุซ ุฃููุงู)
                });


                hideLoading();


                if (allPostings.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ูู ุชูู ุจูุดุฑ ุฃู ุฅุนูุงูุงุช ุฃู ุทูุจุงุช ุจุนุฏ.</p>';
                    return;
                }


                listEl.innerHTML = allPostings.map(post => {
                    const isRequest = post.type === 'request';
                    const title = isRequest ? post.title : post.title;
                    const category = post.category;
                    const description = isRequest ? post.description : post.details;
                    const typeLabel = isRequest ? 'ุทูุจ ุฎุฏูุฉ' : 'ุฅุนูุงู ูุธููุฉ';
                    const typeColor = isRequest ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700';
                    const dateString = post.createdAt && post.createdAt.toDate ? new Date(post.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ุชุงุฑูุฎ ุบูุฑ ูุญุฏุฏ';


                    return `
                        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-medium ${typeColor} py-1 px-2 rounded-full">${typeLabel}</span>
                                <span class="text-xs text-gray-400">${dateString}</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-1">${title}</h3>
                            <p class="text-sm text-gray-600 mb-3">${description.substring(0, 150)}...</p>
                            <p class="text-sm text-indigo-600 mb-3 font-medium">ุงููุณู: ${category}</p>
                            
                            <button data-action="deletePosting" data-type="${post.type}" data-id="${post.id}"
                                    class="mt-2 w-full flex items-center justify-center space-x-1 space-x-reverse bg-red-500 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-red-600 transition-colors">
                                ${ICONS.trash}
                                <span>ุญุฐู ูุฐุง ${isRequest ? 'ุงูุทูุจ' : 'ุงูุฅุนูุงู'}</span>
                            </button>
                        </div>
                    `;
                }).join('');


            } catch (error) {
                console.error("Error fetching my postings: ", error);
                hideLoading();
                listEl.innerHTML = '<p class="text-red-500 p-6 bg-white rounded-lg shadow-sm">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุฅุนูุงูุงุชู ูุทูุจุงุชู.</p>';
            }
        }




        function renderEditProfilePage() {
            if (!userProfile) {
                navigateTo('auth');
                return;
            }




            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}" ${userProfile.jobTitle === service.name ? 'selected' : ''}>${service.name}</option>`
            ).join('');




            const cityOptions = SHARQIA_CITIES.map(city => 
                `<option value="${city}" ${userProfile.addressCity === city ? 'selected' : ''}>${city}</option>`
            ).join('');




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ุชุนุฏูู ุงูููู ุงูุดุฎุตู</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="edit-profile-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="edit-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- ุญูู ุงูุตูุฑุฉ ูุฑูุนูุง ุจุงูุถุบุท -->
                            <div>
                                <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                                <label for="photo-upload-input" class="block text-sm font-medium text-gray-700 text-center cursor-pointer">
                                    ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ
                                    <div class="mt-2 flex flex-col items-center justify-center">
                                        <img id="photo-preview" class="w-24 h-24 rounded-full object-cover border-2 border-indigo-400 p-0.5 hover:border-indigo-700 transition-colors" 
                                             src="${userProfile.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" alt="ุงูุตูุฑุฉ ุงูุญุงููุฉ">
                                        <span class="text-xs text-indigo-500 mt-2 hover:underline">ุงุถุบุท ูุชุบููุฑ ุตูุฑุชู</span>
                                    </div>
                                </label>
                                <input type="hidden" id="photo-base64" value="${userProfile.photoURL || ''}">
                            </div>




                            <hr class="my-3">
                            
                            <div>
                                <label for="edit-name" class="block text-sm font-medium text-gray-700">ุงูุงุณู ุงููุงูู</label>
                                <input type="text" id="edit-name" value="${userProfile.name}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                            <div>
                                <label for="edit-phone" class="block text-sm font-medium text-gray-700">ุฑูู ุงููุงุชู (11 ุฑูู)</label>
                                <input type="tel" id="edit-phone" value="${userProfile.phone}" required pattern="[0-9]{11}" maxlength="11" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                            
                            <!-- === ุฅุตูุงุญ 3: ุงุฎุชูุงุฑ ุงูุฌูุณ === -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ุงูุฌูุณ</label>
                                <div class="mt-1 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="edit-gender" value="ุฐูุฑ" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" ${userProfile.gender === 'ุฐูุฑ' ? 'checked' : ''} required>
                                        <span class="mr-2 text-gray-700 text-sm">ุฐูุฑ</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="edit-gender" value="ุฃูุซู" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" ${userProfile.gender === 'ุฃูุซู' ? 'checked' : ''} required>
                                        <span class="mr-2 text-gray-700 text-sm">ุฃูุซู</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ุชูุณูู ุงูุนููุงู -->
                            <div>
                                <label for="edit-city" class="block text-sm font-medium text-gray-700">ุงููุฑูุฒ / ุงููุฏููุฉ</label>
                                <select id="edit-city" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                    <option value="">ุงุฎุชุฑ ุงููุฑูุฒ/ุงููุฏููุฉ</option>
                                    ${cityOptions}
                                </select>
                            </div>
                            <div>
                                <label for="edit-area" class="block text-sm font-medium text-gray-700">ุงูููุทูุฉ / ุชูุงุตูู ุงูุนููุงู</label>
                                <input type="text" id="edit-area" value="${userProfile.addressArea}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: ุงูููููุฉุ ุดุงุฑุน 33">
                            </div>
                            
                            ${userProfile.role === 'provider' ? `
                                <div id="job-title-edit-field" class="space-y-4">
                                    <div>
                                        <label for="edit-job-select" class="block text-sm font-medium text-gray-700">ุงุฎุชุฑ ูุธููุชู / ุงูุฎุฏูุฉ:</label>
                                        <select id="edit-job-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                            <option value="" ${!userProfile.jobTitle ? 'selected' : ''}>ุงุฎุชุฑ...</option>
                                            ${serviceOptions}
                                        </select>
                                    </div>
                                </div>
                            ` : ''}




                            <button type="submit" data-action="editProfile" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                ุญูุธ ุงูุชุนุฏููุงุช
                            </button>
                        </form>
                    </main>
                </div>
            `;




            // ุชููุฆุฉ ูุณุชูุน ุญุฏุซ ุฑูุน ุงูุตูุฑุฉ
            document.getElementById('photo-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;




                showLoading('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุตูุฑุฉ...');
                try {
                    const base64Image = await resizeAndConvertImage(file);
                    document.getElementById('photo-preview').src = base64Image;
                    document.getElementById('photo-base64').value = base64Image;
                } catch (error) {
                    console.error("Image processing error:", error);
                    showMessageModal('ุฎุทุฃ ูู ุงูุตูุฑุฉ', 'ูู ูุชููู ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ุจุตูุฑุฉ ุฃุฎุฑู.', false);
                } finally {
                    hideLoading();
                }
            });
        }




        async function renderChatPage(otherUserId) {
            let otherUserProfile = null;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, otherUserId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    otherUserProfile = userDoc.data();
                } else {
                    throw new Error('User not found');
                }
            } catch (e) {
                console.error(e);
                appContainer.innerHTML = `<p class="p-4 text-red-500">ุฎุทุฃ: ูุง ูููู ุงูุนุซูุฑ ุนูู ุงููุณุชุฎุฏู.</p>`;
                return;
            }




            // ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูููู ุงูุชูููู
            const isProviderRatingClient = userProfile.role === 'provider' && otherUserProfile.role === 'client';
            const isClientRatingProvider = userProfile.role === 'client' && otherUserProfile.role === 'provider';
            // === ุฅุถุงูุฉ ููุทู ุชูููู ููุฏู ุฎุฏูุฉ ูููุฏู ุฎุฏูุฉ ุขุฎุฑ ===
            const isProviderRatingProvider = userProfile.role === 'provider' && otherUserProfile.role === 'provider';




            appContainer.innerHTML = `
                <div class="flex flex-col h-screen max-h-screen"> 
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between space-x-3 space-x-reverse">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <img data-action="navigateTo" data-page="profile" data-uid="${otherUserId}"
                                 src="${otherUserProfile.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${otherUserProfile.name}" class="w-9 h-9 rounded-full object-cover cursor-pointer">
                            <h1 class="text-base font-bold">${otherUserProfile.name}</h1>
                        </div>
                        
                        <div class="flex items-center space-x-2 space-x-reverse">
                            ${isClientRatingProvider || isProviderRatingProvider ? `
                                <button data-action="openRatingModal" data-targetrole="provider" data-targetid="${otherUserId}" data-targetname="${otherUserProfile.name}"
                                        class="p-1 text-yellow-300 hover:text-yellow-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>
                                </button>
                            ` : ''}
                            ${isProviderRatingClient ? `
                                <button data-action="openRatingClientModal" data-targetrole="client" data-targetid="${otherUserId}" data-targetname="${otherUserProfile.name}"
                                        class="p-1 text-yellow-300 hover:text-yellow-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>
                                </button>
                            ` : ''}
                            <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                                ${ICONS.back}
                            </button>
                        </div>
                    </header>
                    
                    <main id="messages-container" class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-100 no-scrollbar">
                        <p class="text-center text-gray-500 text-sm">ุงุจุฏุฃ ุงููุญุงุฏุซุฉ...</p>
                    </main>
                    
                    <footer class="bg-white p-3 shadow-inner sticky bottom-0 z-10 border-t border-gray-200">
                        <form id="chat-form" class="flex items-center space-x-2 space-x-reverse">
                            <input type="text" id="message-input" class="flex-1 block w-full px-4 py-2 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ุงูุชุจ ุฑุณุงูุชู..." required>
                            <button type="submit" data-action="sendMessage" data-otheruserid="${otherUserId}"
                                    class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                ${ICONS.send}
                            </button>
                        </form>
                    </footer>
                </div>
            `;




            const chatRoomId = [userId, otherUserId].sort().join('_');
            const messagesColRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);




            currentUnsubscribe = onSnapshot(messagesColRef, (snapshot) => {
                const messagesContainer = document.getElementById('messages-container');
                const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50; 




                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">ุงุจุฏุฃ ุงููุญุงุฏุซุฉ...</p>';
                    return;
                }




                const messages = snapshot.docs.map(doc => doc.data());
                messages.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());




                messagesContainer.innerHTML = messages.map(msg => {
                    const isSent = msg.senderId === userId;
                    const bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
                    const alignmentClass = isSent ? 'justify-end' : 'justify-start';




                    return `
                        <div class="flex ${alignmentClass}">
                            <div class="${bubbleClass} max-w-[80%] text-sm">
                                <p>${msg.text}</p>
                                <span class="text-xs ${isSent ? 'text-indigo-100' : 'text-gray-500'} block text-left mt-1">
                                    ${new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');




                // ุงูุชูุฑูุฑ ุงูุชููุงุฆู ุฅูู ุงูุฃุณูู
                if (isNearBottom) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }




            }, (error) => {
                console.error("Error fetching messages: ", error);
                document.getElementById('messages-container').innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฑุณุงุฆู.</p>';
            });
        }




        function renderNewRequestPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ุทูุจ ุฎุฏูุฉ ุฌุฏูุฏ</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="new-request-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="request-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <div>
                                <label for="request-title" class="block text-sm font-medium text-gray-700">ุนููุงู ุงูุทูุจ</label>
                                <input type="text" id="request-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: ุฃุญุชุงุฌ ุณุจุงู ูุฅุตูุงุญ ุตูุจูุฑ">
                            </div>
                            
                            <div>
                                <label for="request-category" class="block text-sm font-medium text-gray-700">ุงููุณู</label>
                                <select id="request-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                    <option value="">ุงุฎุชุฑ ุงููุณู</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label for="request-description" class="block text-sm font-medium text-gray-700">ูุตู ุงูุฎุฏูุฉ ุงููุทููุจุฉ</label>
                                <textarea id="request-description" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุฑุฌู ูุชุงุจุฉ ุชูุงุตูู ุงูุฎุฏูุฉ ุงููุทููุจุฉ..."></textarea>
                            </div>
                            
                            <button type="submit" data-action="submitRequest" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                ูุดุฑ ุงูุทูุจ
                            </button>
                        </form>
                    </main>
                </div>
            `;
        }




        // === ุตูุญุฉ ูุดุฑ ุฅุนูุงู ูุธููุฉ ===
        function renderJobPostingPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ูุดุฑ ุฅุนูุงู ูุธููุฉ</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100 transition-colors">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="job-posting-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="job-post-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <div>
                                <label for="job-title" class="block text-sm font-medium text-gray-700">ุนููุงู ุงููุธููุฉ</label>
                                <input type="text" id="job-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุซุงู: ูุทููุจ ุณูุฑุชูุฑุฉ ุชูููุฐูุฉ">
                            </div>
                            
                            <div>
                                <label for="job-category" class="block text-sm font-medium text-gray-700">ุงููุณู</label>
                                <select id="job-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                                    <option value="">ุงุฎุชุฑ ุงููุณู</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label for="job-details" class="block text-sm font-medium text-gray-700">ุชูุงุตูู ููุชุทูุจุงุช ุงููุธููุฉ</label>
                                <textarea id="job-details" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="ูุฑุฌู ูุชุงุจุฉ ุงูููุงุฑุงุช ุงููุทููุจุฉุ ูุงูุฑุงุชุจ ุงููุชููุนุ ูุงููููุน..."></textarea>
                            </div>
                            
                            <button type="submit" data-action="submitJobPost" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                ูุดุฑ ุฅุนูุงู ุงููุธููุฉ
                            </button>
                        </form>
                    </main>
                    
                    ${renderBottomNav('jobListings')}
                </div>
            `;
        }




        // === ุตูุญุฉ ุนุฑุถ ุฅุนูุงูุงุช ุงููุธุงุฆู ===
        async function renderJobListingsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ุงููุธุงุฆู ุงููุชุงุญุฉ</h1>
                         <button data-action="navigateTo" data-page="jobPosting" 
                            class="bg-indigo-600 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-indigo-700 transition-colors">
                            + ุฅุนูุงู ุฌุฏูุฏ
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="job-listings-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ุฌุงุฑู ุชุญููู ุฅุนูุงูุงุช ุงููุธุงุฆู...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('jobListings')}
                </div>
            `;




            const jobPostingsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
            const q = query(jobPostingsColRef, orderBy('createdAt', 'desc'));




            currentUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('job-listings-list');


                let listings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));


                // === ุชุทุจูู ุงูุญุฐู ุงูุชููุงุฆู (ุงูุฎุงุตูุฉ ุฑูู 2) ===
                const validListings = [];
                for (const job of listings) {
                    const isDeleted = await attemptAutoDelete(job.id, job, 'jobPostings');
                    if (!isDeleted) {
                        validListings.push(job);
                    }
                }
                listings = validListings;




                if (listings.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">ูุง ุชูุฌุฏ ุฅุนูุงูุงุช ูุธุงุฆู ุญุงููุงู.</p>';
                    return;
                }




                listEl.innerHTML = listings.map(job => {
                    const dateString = job.createdAt && job.createdAt.toDate ? new Date(job.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ุชุงุฑูุฎ ุบูุฑ ูุญุฏุฏ';
                    return `
                    <div class="bg-indigo-50 p-4 rounded-lg shadow-md border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-bold text-gray-900">${job.title}</h3>
                            <span class="text-xs text-gray-400">${dateString}</span>
                        </div>
                        <p class="text-sm text-indigo-600 mb-2 font-medium">${job.category}</p>
                        <p class="text-sm text-gray-700 mb-3">${job.details.substring(0, 150)}...</p>
                        
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <img data-action="navigateTo" data-page="profile" data-uid="${job.posterId}"
                                 src="${job.posterPhoto || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${job.posterName}" class="w-8 h-8 rounded-full object-cover cursor-pointer">
                            <p data-action="navigateTo" data-page="profile" data-uid="${job.posterId}" 
                               class="text-xs text-gray-600 cursor-pointer hover:text-indigo-600">ุงููุงุดุฑ: ${job.posterName}</p>
                        </div>
                        
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${job.posterId}"
                                class="mt-3 w-full bg-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors">
                            ุชูุงุตู ููุชูุฏูู
                        </button>
                    </div>
                `}).join('');
            }, (error) => {
                console.error("Error fetching job listings: ", error);
                document.getElementById('job-listings-list').innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุฅุนูุงูุงุช ุงููุธุงุฆู.</p>';
            });
        }




        // === ุฅุตูุงุญ 1 ู 2: ุชุตุบูุฑ ุงุฑุชูุงุน ุดุฑูุท ุงูุชููู ุงูุณููู ูุชุบููุฑ ุงูููู ===
        function renderBottomNav(activeTab) {
            const activeClass = 'text-white bg-indigo-700';
            const inactiveClass = 'text-indigo-300 hover:text-white';




            return `
                <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto md:max-w-2xl lg:max-w-4xl bg-indigo-800 shadow-lg border-t border-indigo-700 z-20">
                    <div class="flex justify-around items-center h-12">
                        <button data-action="navigateTo" data-page="home" 
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'home' ? activeClass : inactiveClass}">
                            ${ICONS.home}
                            <span class="text-xs font-medium">ุงูุฑุฆูุณูุฉ</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="directory" 
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'directory' ? activeClass : inactiveClass}">
                            ${ICONS.users}
                            <span class="text-xs font-medium">ุงูุฏููู</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="chatList" 
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'chatList' ? activeClass : inactiveClass}">
                            ${ICONS.chat}
                            <span class="text-xs font-medium">ุงููุญุงุฏุซุงุช</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="jobListings" 
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'jobListings' ? activeClass : inactiveClass}">
                            ${ICONS.job}
                            <span class="text-xs font-medium">ูุธุงุฆู</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="profile" data-uid="${userId}"
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'profile' ? activeClass : inactiveClass}">
                            ${ICONS.profile}
                            <span class="text-xs font-medium">ูููู</span>
                        </button>
                    </div>
                </nav>
            `;
        }




        function renderStarRating(rating, maxStars = 5, cssClass = 'h-5 w-5') {
            let html = '';
            for (let i = 1; i <= maxStars; i++) {
                if (i <= rating) {
                    html += `<svg class="${cssClass}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`;
                } else {
                    html += `<svg class="${cssClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>`;
                }
            }
            return html;
        }




        // 10. ูุธุงุฆู ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ (Event Handlers)




        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-identifier').value.trim(); 
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');




            showLoading('ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎูู...');
            errorEl.classList.add('hidden');




            try {
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersColRef, where('username', '==', username));
                const snapshot = await getDocs(q); 




                if (snapshot.empty) {
                    throw new Error('ุงุณู ุงููุณุชุฎุฏู ุบูุฑ ุตุญูุญ.');
                }




                const userData = snapshot.docs[0].data();
                const authEmail = userData.email; 




                await signInWithEmailAndPassword(auth, authEmail, password);




                hideLoading();
            } catch (error) {
                console.error("Login Error: ", error);
                let errorMessage = 'ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.';
                if (error.message.includes('ุงุณู ุงููุณุชุฎุฏู ุบูุฑ ุตุญูุญ')) {
                     errorMessage = error.message;
                } else if (error.code === 'auth/invalid-credential') {
                     errorMessage = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.';
                }




                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }




        async function handleRegister(e) {
            e.preventDefault();
            isRegistering = true; 
            showLoading('ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจ...');
            const errorEl = document.getElementById('register-error');
            errorEl.classList.add('hidden');




            try {
                const username = document.getElementById('register-username').value.trim(); 
                const password = document.getElementById('register-password').value;
                const name = document.getElementById('register-name').value;
                const phone = document.getElementById('register-phone').value;
                const gender = document.querySelector('input[name="gender"]:checked').value; // === ุฅุตูุงุญ 3 ===
                const city = document.getElementById('register-city').value;
                const area = document.getElementById('register-area').value.trim();
                const role = document.querySelector('input[name="role"]:checked').value;
                const photoURL = document.getElementById('photo-base64').value || null; 




                const jobSelect = document.getElementById('register-job-select')?.value;
                const jobTitle = jobSelect;




                // ุงูุชุญูู ูู ุฑูู ุงููุงุชู ูุงูุนููุงู
                if (phone.length !== 11 || !/^[0-9]{11}$/.test(phone)) {
                    throw new Error('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ูุงุชู ูุตุฑู ุตุญูุญ ูููู ูู 11 ุฑูู.');
                }
                if (!city || !area) {
                    throw new Error('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฏููุฉ/ุงููุฑูุฒ ูุฅุฏุฎุงู ุชูุงุตูู ุงูููุทูุฉ.');
                }
                if (role === 'provider' && (!jobTitle || jobTitle === '')) {
                    throw new Error('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุธููุฉ ูููุฏู ุงูุฎุฏูุฉ.');
                }




                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersColRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    throw new Error('ุงุณู ุงููุณุชุฎุฏู ูุฐุง ูุญุฌูุฒ ุจุงููุนู. ูุฑุฌู ุงุฎุชูุงุฑ ุงุณู ุขุฎุฑ.');
                }




                const dummyEmail = `${username}@sharqia.service`; // ุชู ุชุญุฏูุซ ุงูุฏูููู
                const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password);
                const newUserId = userCredential.user.uid;




                await updateProfile(userCredential.user, {
                    displayName: name,
                });




                const jobTitleSearch = role === 'provider' ? jobTitle.toLowerCase() : null;




                const newUserProfile = {
                    uid: newUserId,
                    username: username, 
                    email: dummyEmail, 
                    name: name,
                    phone: phone,
                    gender: gender, // === ุฅุตูุงุญ 3 ===
                    addressCity: city, 
                    addressArea: area, 
                    address: `${city}, ${area}`, 
                    photoURL: photoURL, 
                    role: role,
                    jobTitle: role === 'provider' ? jobTitle : null,
                    jobTitleSearch: jobTitleSearch, 
                    createdAt: Timestamp.now(),
                    ratings: [],
                    avgRating: 0,
                    clientRatings: [], // === ุฅุตูุงุญ 3: ุชูููู ุงูุนููู ===
                    clientAvgRating: 0 // === ุฅุตูุงุญ 3: ุชูููู ุงูุนููู ===
                };




                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, newUserId);
                await setDoc(userDocRef, newUserProfile);




                userProfile = newUserProfile;
                userId = newUserId;
                hideLoading();
                showMessageModal('ุชู ุงูุชุณุฌูู ุจูุฌุงุญ', 'ุฃููุงู ุจู ูู ูุณุชูุจู ุงูุดุฑููุฉ!', true);




                setTimeout(() => {
                    navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                }, 1500);




            } catch (error) {
                console.error("Register Error: ", error);
                let displayError = error.message || 'ุญุฏุซ ุฎุทุฃ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
                if (error.code === 'auth/email-already-in-use') {
                    displayError = 'ูุฐุง ุงูุฅูููู/ุงุณู ุงููุณุชุฎุฏู ูุณุฌู ุจุงููุนู.';
                } else if (error.code === 'auth/invalid-email') {
                    displayError = 'ุตูุบุฉ ุงุณู ุงููุณุชุฎุฏู ุบูุฑ ุตุญูุญุฉุ ูุฑุฌู ุงุณุชุฎุฏุงู ุญุฑูู ูุฃุฑูุงู ููุท.';
                } else if (error.code === 'auth/weak-password') {
                    displayError = 'ูููุฉ ุงููุฑูุฑ ุถุนููุฉ ุฌุฏุงูุ ูุฑุฌู ุงุณุชุฎุฏุงู 6 ุฃุญุฑู ุฃู ุฃูุซุฑ.';
                }




                errorEl.textContent = displayError;
                errorEl.classList.remove('hidden');
                hideLoading();
            } finally {
                isRegistering = false; 
            }
        }




        async function handleEditProfile(e) {
            e.preventDefault();
            showLoading('ุฌุงุฑู ุญูุธ ุงูุชุนุฏููุงุช...');
            const errorEl = document.getElementById('edit-error');
            errorEl.classList.add('hidden');




            try {
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const gender = document.querySelector('input[name="edit-gender"]:checked').value; // === ุฅุตูุงุญ 3 ===
                const city = document.getElementById('edit-city').value;
                const area = document.getElementById('edit-area').value.trim();
                const photoURL = document.getElementById('photo-base64').value || null; 




                if (phone.length !== 11 || !/^[0-9]{11}$/.test(phone)) {
                    throw new Error('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ูุงุชู ูุตุฑู ุตุญูุญ ูููู ูู 11 ุฑูู.');
                }
                if (!city || !area) {
                    throw new Error('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฏููุฉ/ุงููุฑูุฒ ูุฅุฏุฎุงู ุชูุงุตูู ุงูููุทูุฉ.');
                }




                let jobTitle = userProfile.jobTitle;
                if (userProfile.role === 'provider') {
                    const jobSelect = document.getElementById('edit-job-select').value;
                    jobTitle = jobSelect;
                }




                showLoading('ุฌุงุฑู ุชุญุฏูุซ ุงูุจูุงูุงุช...');
                const jobTitleSearch = userProfile.role === 'provider' ? jobTitle.toLowerCase() : null;




                const updates = {
                    name: name,
                    phone: phone,
                    gender: gender, // === ุฅุตูุงุญ 3 ===
                    addressCity: city, 
                    addressArea: area, 
                    address: `${city}, ${area}`,
                    photoURL: photoURL, 
                    jobTitle: userProfile.role === 'provider' ? jobTitle : null,
                    jobTitleSearch: jobTitleSearch,
                };




                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await updateDoc(userDocRef, updates);




                await updateProfile(auth.currentUser, {
                    displayName: name,
                });




                userProfile = { ...userProfile, ...updates };




                hideLoading();
                showMessageModal('ุชู ุงูุญูุธ ุจูุฌุงุญ', 'ุชู ุชุญุฏูุซ ูููู ุงูุดุฎุตู.', true);




                setTimeout(() => {
                    navigateTo('profile', { uid: userId });
                }, 1500);




            } catch (error) {
                console.error("Edit Profile Error: ", error);
                errorEl.textContent = error.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุนุฏููุงุช.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }




        async function handleLogout() {
            showLoading('ุฌุงุฑู ุชุณุฌูู ุงูุฎุฑูุฌ...');
            await signOut(auth);
            userId = null;
            userProfile = null;
            hideLoading();
            navigateTo('auth');
        }




        async function handleSendMessage(otherUserId) {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text === '') return;




            input.value = '';




            const chatRoomId = [userId, otherUserId].sort().join('_');
            const messagesColRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);




            try {
                await addDoc(messagesColRef, {
                    text: text,
                    senderId: userId,
                    createdAt: Timestamp.now()
                });




                const otherUserDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users`, otherUserId));
                if (!otherUserDoc.exists()) { throw new Error("Other user not found"); }
                const otherUserData = otherUserDoc.data();




                const chatRoomDocRef = doc(db, `artifacts/${appId}/public/data/chats`, chatRoomId);
                const chatRoomData = {
                    users: [userId, otherUserId],
                    userDetails: {
                        [userId]: { name: userProfile.name, photoURL: userProfile.photoURL },
                        [otherUserId]: { name: otherUserData.name, photoURL: otherUserData.photoURL }
                    },
                    lastMessage: text,
                    lastSenderId: userId,
                    lastUpdate: Timestamp.now()
                };
                await setDoc(chatRoomDocRef, chatRoomData, { merge: true });




            } catch (error) {
                console.error("Error sending message: ", error);
            }
        }




        async function handleSubmitRequest(e) {
            e.preventDefault();
            showLoading('ุฌุงุฑู ูุดุฑ ุงูุทูุจ...');
            const errorEl = document.getElementById('request-error');
            errorEl.classList.add('hidden');




            try {
                const title = document.getElementById('request-title').value;
                const category = document.getElementById('request-category').value;
                const description = document.getElementById('request-description').value;




                if (!title || !category || !description) {
                    throw new Error('ูุฑุฌู ููุก ุฌููุน ุงูุญููู.');
                }




                const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
                await addDoc(requestsColRef, {
                    title: title,
                    category: category,
                    description: description,
                    requesterId: userId,
                    requesterName: userProfile.name,
                    requesterPhoto: userProfile.photoURL,
                    status: 'open',
                    createdAt: Timestamp.now()
                });




                hideLoading();
                showMessageModal('ุชู ูุดุฑ ุงูุทูุจ', 'ูููู ูููุฏูู ุงูุฎุฏูุงุช ุงูุขู ุฑุคูุฉ ุทูุจู ูุงูุชูุงุตู ูุนู.', true);




                setTimeout(() => {
                    navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                }, 1500);




            } catch (error) {
                console.error("Error submitting request: ", error);
                errorEl.textContent = error.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุดุฑ ุงูุทูุจ.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }




        // === ุฅุฑุณุงู ุฅุนูุงู ูุธููุฉ ===
        async function handleSubmitJobPost(e) {
            e.preventDefault();
            showLoading('ุฌุงุฑู ูุดุฑ ุฅุนูุงู ุงููุธููุฉ...');
            const errorEl = document.getElementById('job-post-error');
            errorEl.classList.add('hidden');




            try {
                const title = document.getElementById('job-title').value;
                const category = document.getElementById('job-category').value;
                const details = document.getElementById('job-details').value;




                if (!title || !category || !details) {
                    throw new Error('ูุฑุฌู ููุก ุฌููุน ุงูุญููู.');
                }




                const jobPostingsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
                await addDoc(jobPostingsColRef, {
                    title: title,
                    category: category,
                    details: details,
                    posterId: userId,
                    posterName: userProfile.name,
                    posterPhoto: userProfile.photoURL,
                    createdAt: Timestamp.now()
                });




                hideLoading();
                showMessageModal('ุชู ูุดุฑ ุงูุฅุนูุงู', 'ุชู ูุดุฑ ุฅุนูุงู ุงููุธููุฉ ุจูุฌุงุญ.', true);




                setTimeout(() => {
                    navigateTo('jobListings');
                }, 1500);




            } catch (error) {
                console.error("Error submitting job post: ", error);
                errorEl.textContent = error.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุดุฑ ุงูุฅุนูุงู.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }


        // === ุฏุงูุฉ ุญุฐู ุฅุนูุงู/ุทูุจ ===
        async function handleDeletePosting(type, id) {
             const collectionName = type === 'request' ? 'serviceRequests' : 'jobPostings';
             const confirmDelete = await new Promise(resolve => {
                showModal(`
                    <h2 class="text-xl font-semibold text-center text-red-600 mb-4">ุชุฃููุฏ ุงูุญุฐู</h2>
                    <p class="text-center text-gray-700">ูู ุฃูุช ูุชุฃูุฏ ูู ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ${type === 'request' ? 'ุงูุทูุจ' : 'ุงูุฅุนูุงู'}ุ</p>
                    <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                        <button data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                            ุฅูุบุงุก
                        </button>
                        <button data-action="confirmDelete" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-red-600 hover:bg-red-700 text-sm">
                            ุชุฃููุฏ ุงูุญุฐู
                        </button>
                    </div>
                `);
                document.querySelector('[data-action="confirmDelete"]').addEventListener('click', () => {
                    hideModal();
                    resolve(true);
                });
                document.querySelector('[data-action="closeModal"]').addEventListener('click', () => {
                    hideModal();
                    resolve(false);
                });
            });


            if (!confirmDelete) return;


            showLoading('ุฌุงุฑู ุงูุญุฐู...');
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, id);
                await deleteDoc(docRef);
                hideLoading();
                showMessageModal('ูุฌุงุญ', `ุชู ุญุฐู ${type === 'request' ? 'ุงูุทูุจ' : 'ุงูุฅุนูุงู'} ุจูุฌุงุญ.`, true);
                // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุนุฑุถ ุงูุชุญุฏูุซ
                setTimeout(() => {
                    navigateTo('myPostings');
                }, 1000); 
            } catch (error) {
                console.error("Error deleting posting: ", error);
                hideLoading();
                showMessageModal('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.', false);
            }
        }




        function handleOpenRatingModal(targetRole, targetId, targetName) {
            const modalHtml = `
                <h2 class="text-xl font-semibold text-center mb-4">ุชูููู ${targetName} (${targetRole === 'provider' ? 'ููุฏู ุฎุฏูุฉ' : 'ุนููู'})</h2>
                <div id="rating-stars" class="flex justify-center text-gray-300 space-x-2 space-x-reverse mb-4 cursor-pointer">
                    ${[1,2,3,4,5].map(i => `<span data-action="setRating" data-value="${i}" class="star-icon hover:text-yellow-400">${ICONS.starEmpty}</span>`).join('')}
                </div>
                <input type="hidden" id="rating-value" value="0">
                <textarea id="rating-comment" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="ุงูุชุจ ุชุนูููู ููุง..."></textarea>
                <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                    <button data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                        ุฅูุบุงุก
                    </button>
                    <button data-action="submitRating" data-targetrole="${targetRole}" data-targetid="${targetId}" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-sm">
                        ุฅุฑุณุงู ุงูุชูููู
                    </button>
                </div>
            `;
            showModal(modalHtml);
        }




        // === ุชูุญูุฏ ุฏุงูุฉ ุฅุฑุณุงู ุงูุชูููู ููููุฏู ูุงูุนููู ===
        async function handleSubmitRating(targetId, targetRole) {
            const stars = parseInt(document.getElementById('rating-value').value);
            const comment = document.getElementById('rating-comment').value.trim();




            if (stars === 0) {
                showMessageModal('ุฎุทุฃ', 'ูุฑุฌู ุงุฎุชูุงุฑ ุนุฏุฏ ุงููุฌูู ูุชูููู ุงููุณุชุฎุฏู.', false);
                return;
            }




            showLoading('ุฌุงุฑู ุฅุฑุณุงู ุงูุชูููู...');




            try {
                const targetDocRef = doc(db, `artifacts/${appId}/public/data/users`, targetId);
                const ratingFieldName = targetRole === 'provider' ? 'ratings' : 'clientRatings';
                const avgRatingFieldName = targetRole === 'provider' ? 'avgRating' : 'clientAvgRating';




                await runTransaction(db, async (transaction) => {
                    const targetDoc = await transaction.get(targetDocRef);
                    if (!targetDoc.exists()) {
                        throw "Target user document does not exist!";
                    }




                    const data = targetDoc.data();
                    const oldRatings = data[ratingFieldName] || [];
                    const filteredRatings = oldRatings.filter(r => r.by !== userId);




                    const newRating = {
                        by: userId,
                        byName: userProfile.name,
                        stars: stars,
                        comment: comment,
                        createdAt: Timestamp.now()
                    };
                    const newRatings = [...filteredRatings, newRating];




                    // โ๏ธ ุชู ุชุตุญูุญ ุงูุฎุทุฃ ููุง: ุฅุถุงูุฉ ุงูููุณ ุงููุงูุต ุจุนุฏ r
                    const totalStars = newRatings.reduce((acc, r) => acc + r.stars, 0);
                    const newAvgRating = totalStars / newRatings.length;




                    const updates = {};
                    updates[ratingFieldName] = newRatings;
                    updates[avgRatingFieldName] = newAvgRating;




                    transaction.update(targetDocRef, updates);
                });




                hideLoading();
                hideModal();
                showMessageModal('ูุฌุงุญ', 'ุดูุฑุงู ูุชููููู!', true);




            } catch (error) {
                console.error("Error submitting rating: ", error);
                hideLoading();
                showMessageModal('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุชูููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.', false);
            }
        }




        // 11. Event Delegation (ุงููุณุชูุน ุงูุฑุฆูุณู ููุฃุญุฏุงุซ)
        appContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;




            const action = target.dataset.action;
            const page = target.dataset.page;
            const uid = target.dataset.uid;
            const category = target.dataset.category;
            const otherUserId = target.dataset.otheruserid;
            const targetId = target.dataset.targetid;
            const targetName = target.dataset.targetname;
            const targetRole = target.dataset.targetrole;
            const type = target.dataset.type;
            const id = target.dataset.id;




            switch (action) {
                case 'navigateTo':
                    if (page === 'profile') navigateTo(page, { uid });
                    else if (page === 'category') navigateTo(page, { category });
                    else if (page === 'chat') navigateTo(page, { otherUserId });
                    else if (page === 'home') navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                    else navigateTo(page);
                    break;




                case 'goBack':
                    // === ุฅุตูุงุญ ููุทู ุฒุฑ ุงูุฑุฌูุน ===
                    if (navigationHistory.length > 1) {
                        navigationHistory.pop(); // 1. ุฅุฒุงูุฉ ุงูุตูุญุฉ ุงูุญุงููุฉ ูู ุงูุณุฌู
                        const previousRoute = navigationHistory[navigationHistory.length - 1]; // 2. ุงูุญุตูู ุนูู ุงูุตูุญุฉ ุงูุณุงุจูุฉ
                        navigateTo(previousRoute.page, previousRoute.params); // 3. ุงูุงูุชูุงู ุฅูููุง (ูู ูุชู ุฅุถุงูุชูุง ูุฑุฉ ุฃุฎุฑู ุจุณุจุจ ููุทู navigateTo)
                    } else if (userId) {
                         navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                    } else {
                         navigateTo('auth');
                    }
                    break;




                case 'login':
                    e.preventDefault();
                    await handleLogin(e); 
                    break;
                case 'register':
                    e.preventDefault();
                    await handleRegister(e);
                    break;
                case 'logout':
                    await handleLogout();
                    break;
                case 'editProfile': 
                    e.preventDefault();
                    await handleEditProfile(e);
                    break;
                case 'sendMessage':
                    e.preventDefault();
                    await handleSendMessage(otherUserId);
                    break;
                case 'submitRequest':
                    e.preventDefault();
                    await handleSubmitRequest(e);
                    break;
                case 'submitJobPost': 
                    e.preventDefault();
                    await handleSubmitJobPost(e);
                    break;
                case 'deletePosting': 
                    await handleDeletePosting(type, id);
                    break;
                case 'openRatingModal': // ุชูููู ููุฏู ุงูุฎุฏูุฉ
                    handleOpenRatingModal('provider', targetId, targetName);
                    break;
                case 'openRatingClientModal': // ุชูููู ุงูุนููู 
                    handleOpenRatingModal('client', targetId, targetName);
                    break;
            }
        });




        modalBackdrop.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target && e.target === modalBackdrop) {
                return;
            }
            if(!target) return;




            const action = target.dataset.action;
            switch(action) {
                case 'closeModal':
                    hideModal();
                    break;
                case 'setRating':
                    const value = parseInt(target.dataset.value);
                    document.getElementById('rating-value').value = value;
                    const stars = document.querySelectorAll('#rating-stars .star-icon');
                    stars.forEach((star, index) => {
                        if (index < value) {
                            star.innerHTML = ICONS.star;
                            star.classList.add('text-yellow-400');
                        } else {
                            star.innerHTML = ICONS.starEmpty;
                            star.classList.remove('text-yellow-400');
                        }
                    });
                    break;
                case 'submitRating':
                    const targetId = target.dataset.targetid;
                    const targetRole = target.dataset.targetrole;
                    handleSubmitRating(targetId, targetRole);
                    break;
            }
        });




        appContainer.addEventListener('change', (e) => {
            if (e.target.name === 'role') {
                const jobField = document.getElementById('job-title-field');
                if (e.target.value === 'provider') {
                    jobField.classList.remove('hidden');
                } else {
                    jobField.classList.add('hidden');
                }
            }
        });




        appContainer.addEventListener('submit', (e) => {
            e.preventDefault();
        });




        // 13. ููุทุฉ ุงูุจุฏุงูุฉ ุงูุฑุฆูุณูุฉ
        window.onload = () => {
            navigateTo('loading');




            onAuthStateChanged(auth, async (user) => {




                if (isRegistering) {
                    console.log('Registration in progress, onAuthStateChanged will wait.');
                    return; 
                }




                if (user) {
                    console.log('User is signed in:', user.uid);
                    userId = user.uid;




                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDoc = await getDoc(userDocRef);




                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                        console.log('User profile found:', userProfile);




                        // ุฅุนุงุฏุฉ ุงูุชูุฌูู ููุตูุญุฉ ุงูููุงุณุจุฉ
                        if(navigationHistory.length <= 1 || navigationHistory[navigationHistory.length - 1].page === 'auth' || navigationHistory[navigationHistory.length - 1].page === 'register') {
                            navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                        } else {
                            // ุฅุฐุง ูุงู ูู ุตูุญุฉ ูุงุ ุงุชุฑูู ููุงู
                            navigateTo(navigationHistory[navigationHistory.length - 1].page, navigationHistory[navigationHistory.length - 1].params);
                        }
                    } else {
                        console.log('No profile found, redirecting to register.');
                        navigateTo('register');
                    }
                } else {
                    console.log('User is signed out.');
                    userId = null;
                    userProfile = null;
                    navigateTo('auth');
                }
            });




            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Signing in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                         console.log("No token, onAuthStateChanged will handle.");
                    }
                } catch (error) {
                    console.error("Error during initial auth:", error);
                    navigateTo('auth');
                }
            })();
        };

        // 14. PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // ูุฌุจ ุฃู ูููู ููู service-worker.js ููุฌูุฏุงู ูู ุงููุฌูุฏ ุงูุฑุฆูุณู
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }




    </script>
    <!-- ============================================= -->
    <!-- ==== ููุงูุฉ ููุฏ ุฌุงูุงุณูุฑูุจุช ู Firebase ===== -->
    <!-- ============================================= -->



</script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js');
      }
    </script>
</body>
</html>
